# Mergify Configuration
# Aligned with GitHub repository rulesets for jbcom/strata
#
# GitHub Main Ruleset Requirements:
# - Squash merge only
# - Required status check: Mergify Merge Protections
# - Required linear history
# - CodeQL code scanning (high_or_higher)

queue_rules:
  # Urgent queue - for hotfixes and critical PRs
  - name: urgent
    autoqueue: true
    merge_method: squash
    batch_size: 1
    queue_conditions:
      - label = urgent
      - base = main
    merge_conditions:
      - check-success = Build and Test
      - check-success = CodeQL

  # Default queue - standard PRs
  - name: default
    autoqueue: true
    merge_method: squash
    batch_size: 2
    batch_max_wait_time: 2 min
    queue_conditions:
      - base = main
      - -label = urgent
      - -label = do-not-merge
      - -draft
    merge_conditions:
      - check-success = Build and Test
      - check-success = CodeQL

# Pull request automation rules
pull_request_rules:
  # Delete head branches after merge
  - name: Delete head branch after merge
    conditions:
      - merged
    actions:
      delete_head_branch:

  # Label PRs based on files changed
  - name: Label documentation changes
    conditions:
      - files ~= ^docs/
    actions:
      label:
        add:
          - documentation

  - name: Label CI/config changes
    conditions:
      - or:
          - files ~= ^\.github/
          - files ~= ^\.mergify\.yml$
    actions:
      label:
        add:
          - ci

  # Warn on stale PRs
  - name: Warn on conflicts
    conditions:
      - conflict
    actions:
      comment:
        message: |
          @{{author}} this PR has merge conflicts. Please resolve them.

# Merge protections - branch protection rules enforced by Mergify
merge_protections:
  # Require CI to pass for all PRs targeting main
  - name: CI Must Pass
    description: All PRs must pass CI before merging
    if:
      - base = main
    success_conditions:
      - check-success = Build and Test

  # Require CodeQL security scanning
  - name: Security Scanning Required
    description: CodeQL must pass for security compliance
    if:
      - base = main
    success_conditions:
      - check-success = CodeQL

  # Ensure no merge conflicts
  - name: No Conflicts
    description: PRs must not have merge conflicts
    if:
      - base = main
    success_conditions:
      - -conflict
